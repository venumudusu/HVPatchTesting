---
- name: Hyper-V Cluster Health Check Report
  hosts: all
  gather_facts: false
  tasks:
    - name: Create temp file
      win_tempfile:
        state: file
        suffix: html
      register: tempfile_1

    - name: Run PowerShell Script
      script: ClusterHealthCheck.ps1 -ClusterName {{ servers }} -htmlfile {{ tempfile_1.path }}

    - name: Fetch output from Cluster
      fetch:
        src: "{{ tempfile_1.path }}"
        dest: /tmp/logs
        htmlcontent: "{{ lookup('file','{{ tempfile_1.path }}') }}"

    - name: Send mail
      mail:
        host: mail.winadmin.org
        port: 587
        username: admin@winadmin.org
        password: creMa6u7!
        to: vg@live.in
        from: admin@winadmin.org
        subject: Hyper-V CLuster Health Check Report
        subtype: html
        body: {{ htmlcontent }}
        